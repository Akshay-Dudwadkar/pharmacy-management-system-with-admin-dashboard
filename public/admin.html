<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Jay Bhavani Medical</title>
  <link href="https://cdn.jsdelivr.net/npm/chart.js" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }

    .sidebar {
      height: 100vh;
      width: 220px;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #1565c0;
      padding-top: 20px;
      color: white;
      display: flex;
      flex-direction: column;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      color: white;
      padding: 12px 20px;
      text-decoration: none;
      transition: background 0.3s;
    }

    .sidebar a:hover {
      background-color: #0d47a1;
    }

    .sidebar a i {
      margin-right: 10px;
    }

    .main {
      margin-left: 220px;
      padding: 20px;
    }

    .dashboard-cards {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .card {
      flex: 1 1 200px;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card h3 {
      margin: 0;
      font-size: 1.2rem;
      color: #1565c0;
    }

    .card p {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #1565c0;
      color: white;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    button {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #1976d2;
      color: white;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #0d47a1;
    }

    input,
    select {
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .section {
      display: none;
    }

    .visible {
      display: block;
    }

    h2 {
      margin-bottom: 20px;
    }

    /* Dashboard Charts */
    .chart-container {
      margin: 30px 0;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    /* Dark Mode */
    .dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }

    .dark-mode .sidebar {
      background-color: #1e1e1e;
    }

    .dark-mode table {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }

    .dark-mode th {
      background-color: #333;
      color: #fff;
    }

    .dark-mode .card {
      background-color: #1f1f1f;
      color: #e0e0e0;
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        flex-direction: row;
        overflow-x: auto;
      }

      .sidebar h2 {
        font-size: 1.2rem;
        margin: 10px;
      }

      .sidebar a {
        flex: 1;
        justify-content: center;
        font-size: 0.9rem;
        padding: 10px;
      }

      .main {
        margin-left: 0;
        margin-top: 10px;
        padding: 10px;
      }

      .dashboard-cards {
        flex-direction: column;
      }

      .card {
        width: 100%;
      }

      .chart-container {
        padding: 10px;
      }

      table {
        font-size: 0.85rem;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      th,
      td {
        padding: 8px;
      }

      button {
        padding: 4px 8px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .sidebar {
        flex-direction: column;
        align-items: flex-start;
      }

      .sidebar a {
        justify-content: flex-start;
        padding: 8px 12px;
      }

      h2 {
        font-size: 1.2rem;
      }

      .card h3 {
        font-size: 1rem;
      }

      .card p {
        font-size: 1.2rem;
      }
    }
  </style>
</head>

<body>

  <div class="sidebar">
    <h2>Admin</h2>
    <a href="#" onclick="showSection('dashboard')"><i>üè†</i> Dashboard</a>
    <a href="#" onclick="showSection('products')"><i>üì¶</i> Products</a>
    <a href="#" onclick="showSection('orders')"><i>üõí</i> Orders</a>
    <a href="#" onclick="showSection('feedback')"><i>üí¨</i> Feedback</a>
    <a href="#" onclick="showSection('users')"><i>üë•</i> Users</a>
  </div>

  <div class="main">

    <!-- Dashboard Overview -->
    <div id="dashboard" class="section visible">
      <h2>Dashboard Overview</h2>
      <div class="dashboard-cards">
        <div class="card">
          <h3>Total Products</h3>
          <p id="totalProducts">0</p>
        </div>
        <div class="card">
          <h3>Total Orders</h3>
          <p id="totalOrders">0</p>
        </div>
        <div class="card">
          <h3>Total Users</h3>
          <p id="totalUsers">0</p>
        </div>
        <div class="card">
          <h3>Average Rating</h3>
          <p id="avgRating">0 ‚òÖ</p>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="ordersChart" height="150"></canvas>
      </div>

      <div class="chart-container">
        <canvas id="ordersStatusChart" height="150"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="newUsersChart" height="150"></canvas>
      </div>

    </div>

    <!-- Product Management -->
    <div id="products" class="section">
      <h2>Product Management</h2>
      <form id="addProductForm">
        <input type="text" placeholder="Product Name" id="productName" required />
        <input type="number" placeholder="Price" id="productPrice" required />
        <select id="productCategory" required>
          <option value="">Select Category</option>
          <option value="Allopathic">Allopathic</option>
          <option value="Ayurvedic">Ayurvedic</option>
          <option value="Cosmetic">Cosmetic</option>
          <option value="Surgical">Surgical</option>
        </select>
        <input type="file" accept="image/*" id="productImage" required>
        <div id="preview"></div>
        <button type="submit">Add Product</button>
      </form>
      <table>
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Price</th>
            <th>Category</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
      </table>
    </div>

    <!--  Order Management -->

    <div id="orders" class="section">
      <h2>Order Management</h2>
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Items</th>
            <th>Total</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Change Status</th>
            <th>Date</th>
            <th>Address</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="orderTableBody"></tbody>
      </table>
    </div>







    <div id="feedback" class="section">
      <h2>Feedback Management</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Rating</th>
            <th>Feedback</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="feedbackTableBody"></tbody>
      </table>
    </div>

    <div id="users" class="section">
      <h2>User Management</h2>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Signup Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody"></tbody>
      </table>
    </div>
  </div>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Toggle sections
    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('visible'));
      document.getElementById(id).classList.add('visible');
    }

    // Load Dashboard Stats
    async function loadDashboardStats() {
      try {
        const [productsRes, ordersRes, usersRes, feedbackRes] = await Promise.all([
          fetch('/api/products'),
          fetch('/api/orders'),
          fetch('/api/users'),
          fetch('/api/feedbacks')
        ]);
        const [products, orders, users, feedbacks] = await Promise.all([
          productsRes.json(), ordersRes.json(), usersRes.json(), feedbackRes.json()
        ]);

        document.getElementById('totalProducts').textContent = products.length;
        document.getElementById('totalOrders').textContent = orders.length;
        document.getElementById('totalUsers').textContent = users.length;

        const avgRating = feedbacks.length
          ? (feedbacks.reduce((s, f) => s + f.rating, 0) / feedbacks.length).toFixed(1)
          : 0;
        document.getElementById('avgRating').textContent = `${avgRating} ‚òÖ`;
      } catch (err) { console.error(err); }
    }

    // Orders by Month Chart
    async function loadOrdersChart() {
      const res = await fetch('/api/orders');
      const orders = await res.json();
      const monthly = Array(12).fill(0);
      orders.forEach(o => monthly[new Date(o.createdAt).getMonth()]++);
      new Chart(document.getElementById('ordersChart'), {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [{ label: 'Orders', data: monthly, borderColor: '#1565c0', backgroundColor: 'rgba(21,101,192,0.2)', fill: true, tension: 0.4 }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // Orders by Status Pie Chart
    async function loadOrdersStatusChart() {
      const res = await fetch('/api/orders');
      const orders = await res.json();
      const statusCount = { Pending: 0, Processing: 0, Shipped: 0, Delivered: 0, Cancelled: 0 };
      orders.forEach(o => statusCount[o.status || 'Pending']++);
      new Chart(document.getElementById('ordersStatusChart'), {
        type: 'pie',
        data: {
          labels: Object.keys(statusCount),
          datasets: [{
            data: Object.values(statusCount),
            backgroundColor: ['#1565c0', '#43a047', '#fbc02d', '#e53935', '#9e9e9e']
          }]
        }
      });
    }

    // Users by Month Chart
    async function loadUsersChart() {
      const res = await fetch('/api/users');
      const users = await res.json();
      const monthly = Array(12).fill(0);
      users.forEach(u => monthly[new Date(u.createdAt).getMonth()]++);
      new Chart(document.getElementById('newUsersChart'), {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [{ label: 'New Users', data: monthly, backgroundColor: '#43a047' }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // Load Tables
    async function loadProducts() {
      const res = await fetch('/api/products'); const products = await res.json();
      const tbody = document.getElementById('productTable'); tbody.innerHTML = '';
      products.forEach(p => {
        const row = `<tr><td>${p.name}</td><td>${p.price}</td>
      <td><button onclick="deleteProduct('${p._id}')" class="delete">Delete</button></td></tr>`;
        tbody.innerHTML += row;
      });
    }
    async function loadOrders() {
      const res = await fetch('/api/orders'); const orders = await res.json();
      const tbody = document.getElementById('orderTable'); tbody.innerHTML = '';
      orders.forEach(o => {
        const row = `<tr><td>${o._id}</td><td>${o.status}</td>
      <td><button onclick="deleteOrder('${o._id}')" class="delete">Delete</button></td></tr>`;
        tbody.innerHTML += row;
      });
    }
    async function loadUsers() {
      const res = await fetch('/api/users'); const users = await res.json();
      const tbody = document.getElementById('userTable'); tbody.innerHTML = '';
      users.forEach(u => {
        const row = `<tr><td>${u.name}</td><td>${u.email}</td>
      <td><button onclick="deleteUser('${u._id}')" class="delete">Delete</button></td></tr>`;
        tbody.innerHTML += row;
      });
    }
    async function loadFeedbacks() {
      const res = await fetch('/api/feedbacks'); const feedbacks = await res.json();
      const tbody = document.getElementById('feedbackTable'); tbody.innerHTML = '';
      feedbacks.forEach(f => {
        const row = `<tr><td>${f.user}</td><td>${f.comment}</td><td>${f.rating}</td>
      <td><button onclick="deleteFeedback('${f._id}')" class="delete">Delete</button></td></tr>`;
        tbody.innerHTML += row;
      });
    }

    // Delete functions
    async function deleteProduct(id) { await fetch('/admin/delete-product', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) }); loadProducts(); }
    async function deleteOrder(id) { await fetch('/admin/delete-order', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) }); loadOrders(); }
    async function deleteUser(id) { await fetch('/admin/delete-user', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) }); loadUsers(); }
    async function deleteFeedback(id) { await fetch('/admin/delete-feedback', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) }); loadFeedbacks(); }

    // On Page Load
    // window.onload = () => {
    //   loadDashboardStats();
    //   loadOrdersChart();
    //   loadOrdersStatusChart();
    //   loadUsersChart();
    //   loadProducts();
    //   loadOrders();
    //   loadUsers();
    //   loadFeedbacks();
    // };

    <!-- Product Management -->

    function showSection(id) {
      const sections = document.querySelectorAll('.section');
      sections.forEach(sec => sec.classList.remove('visible'));
      document.getElementById(id).classList.add('visible');
    }

    const productImageInput = document.getElementById("productImage");
    const preview = document.getElementById("preview");
    const addProductForm = document.getElementById("addProductForm");
    const productTableBody = document.getElementById("productTableBody");
    const submitBtn = addProductForm.querySelector('button[type="submit"]');

    productImageInput.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.innerHTML = `<img src="${e.target.result}" width="100"/>`;
        };
        reader.readAsDataURL(file);
      }
    });

    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const products = await res.json();
        productTableBody.innerHTML = '';
        products.forEach(p => {
          const row = document.createElement("tr");
          row.setAttribute("data-name", p.name);
          row.innerHTML = `
          <td><img src="${p.img}" width="50"/></td>
          <td>${p.name}</td>
          <td>‚Çπ${p.price}</td>
          <td>${p.category}</td>
          <td>
            <button onclick="editProduct(this)">Edit</button>
            <button onclick="deleteProduct(this)">Delete</button>
          </td>
        `;
          productTableBody.appendChild(row);
        });
      } catch (err) {
        console.error("Error loading products", err);
      }
    }

    // window.onload = loadProducts;

    addProductForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const name = document.getElementById("productName").value;
      const price = document.getElementById("productPrice").value;
      const category = document.getElementById("productCategory").value;
      const file = productImageInput.files[0];
      const oldName = submitBtn.dataset.editing;

      const handleSubmit = async (imageBase64 = null) => {
        const payload = { name, price, category };
        if (imageBase64) payload.imageBase64 = imageBase64;
        if (oldName) payload.oldName = oldName;

        const url = oldName ? '/admin/update-product' : '/admin/add-product';

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (!res.ok) return alert(result.message || 'Operation failed');

        alert(oldName ? 'Product updated!' : 'Product added!');
        addProductForm.reset();
        preview.innerHTML = '';
        submitBtn.textContent = "Add Product";
        delete submitBtn.dataset.editing;
        loadProducts();
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = e => handleSubmit(e.target.result);
        reader.readAsDataURL(file);
      } else {
        handleSubmit();
      }
    });

    function editProduct(button) {
      const row = button.closest("tr");
      const name = row.children[1].textContent;
      const price = row.children[2].textContent.replace('‚Çπ', '');
      const category = row.children[3].textContent;

      document.getElementById("productName").value = name;
      document.getElementById("productPrice").value = price;
      document.getElementById("productCategory").value = category;

      submitBtn.textContent = "Update Product";
      submitBtn.dataset.editing = name;
      window.scrollTo(0, 0);
    }

    async function deleteProduct(button) {
      const row = button.closest("tr");
      const name = row.getAttribute("data-name");
      if (!confirm(`Delete product "${name}"?`)) return;

      try {
        const res = await fetch('/admin/delete-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const result = await res.json();
        if (res.ok) {
          row.remove();
          alert("Product deleted");
        } else {
          alert(result.message || "Failed to delete product");
        }
      } catch (err) {
        console.error(err);
        alert("Server error");
      }
    }

    //  Order Management 

    async function loadOrders() {
      const res = await fetch('/admin/orders');
      const orders = await res.json();
      const table = document.getElementById("orderTableBody");
      table.innerHTML = '';

      orders.forEach(order => {
        const items = order.cart.map(i =>
          `${i.name} √ó ${i.quantity}<br>`
        ).join('');

        //  Display username or 'Guest'
        const username = order.userId?.username || 'Guest';

        const row = document.createElement('tr');
        row.innerHTML = `
  <td>${username}</td>
  <td>${items}</td>
  <td>‚Çπ${order.totalCost}</td>
  <td>${order.paymentMethod}</td>
  <td>${order.status || 'Pending'}</td>
  <td>
    <select onchange="updateOrderStatus('${order._id}', this.value)">
      <option value="">Change</option>
      <option value="Pending">Pending</option>
      <option value="Processing">Processing</option>
      <option value="Shipped">Shipped</option>
      <option value="Delivered">Delivered</option>
      <option value="Canceled">Canceled</option>
    </select>
  </td>
  <td>${new Date(order.createdAt).toLocaleString()}</td>
  <td>${order.address || 'No address provided'}</td>
  <td><button onclick="deleteOrder('${order._id}')">Delete</button></td>
`;

        table.appendChild(row);
      });
    }

    async function updateOrderStatus(orderId, status) {
      if (!status) return;
      const res = await fetch('/admin/update-order-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId, status })
      });

      const result = await res.json();
      alert(result.message || 'Updated');
      loadOrders();
    }

    // Load orders when admin page loads
    // window.onload = () => {
    //   loadProducts();
    //   loadOrders();
    // };

    async function deleteOrder(orderId) {
      if (!confirm("Are you sure you want to delete this order?")) return;

      const res = await fetch('/admin/delete-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId })
      });

      const result = await res.json();
      alert(result.message || 'Order deleted');
      loadOrders();
    }


    async function loadFeedbacks() {
      const res = await fetch('/admin/feedbacks');
      const feedbacks = await res.json();
      const table = document.getElementById("feedbackTableBody");
      table.innerHTML = '';

      feedbacks.forEach(fb => {
        const row = document.createElement('tr');
        row.innerHTML = `
      <td>${fb.name}</td>
      <td>${fb.email}</td>
      <td>${fb.rating} ‚òÖ</td>
      <td>${fb.feedback}</td>
      <td><button onclick="deleteFeedback('${fb._id}')">Delete</button></td>
    `;
        table.appendChild(row);
      });
    }

    async function deleteFeedback(feedbackId) {
      if (!confirm("Are you sure you want to delete this feedback?")) return;

      const res = await fetch('/admin/delete-feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ feedbackId })
      });

      const result = await res.json();
      alert(result.message || 'Feedback deleted');
      loadFeedbacks();
    }

    // ‚úÖ Load feedbacks when admin page loads
    // window.onload = () => {
    //   loadProducts();
    //   loadOrders();
    //   loadFeedbacks();
    // };

    // ‚úÖ Load all users
    async function loadUsers() {
      const res = await fetch('/admin/users');
      const users = await res.json();
      const table = document.getElementById("userTableBody");
      table.innerHTML = '';

      users.forEach(user => {
        const status = user.banned ? 'Banned' : 'Active';
        const row = document.createElement('tr');
        row.innerHTML = `
      <td>${user.username}</td>
      <td>${user.email}</td>
      <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</td>
      <td>${status}</td>
      <td>
        <button onclick="toggleBan('${user._id}', ${!user.banned})">${user.banned ? 'Unban' : 'Ban'}</button>
        <button onclick="deleteUser('${user._id}')">Delete</button>
      </td>
    `;
        table.appendChild(row);
      });
    }

    // ‚úÖ Ban/Unban a user
    async function toggleBan(userId, banned) {
      if (!confirm(`Are you sure you want to ${banned ? 'ban' : 'unban'} this user?`)) return;

      const res = await fetch('/admin/toggle-ban', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, banned })
      });
      const result = await res.json();
      alert(result.message);
      loadUsers();
    }

    // ‚úÖ Delete a user
    async function deleteUser(userId) {
      if (!confirm("Are you sure you want to delete this user?")) return;

      const res = await fetch('/admin/delete-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });
      const result = await res.json();
      alert(result.message);
      loadUsers();
    }

    // ‚úÖ Load users when admin page loads
    // On Page Load
    window.addEventListener("load", () => {
      // Dashboard stats + charts
      loadDashboardStats();
      loadOrdersChart();
      loadOrdersStatusChart();
      loadUsersChart();

      // Tables
      loadProducts();
      loadOrders();
      loadUsers();
      loadFeedbacks();
    });


  </script>
</body>

</html>